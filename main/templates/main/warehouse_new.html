<!-- main/templates/main/warehouse_new.html -->

{% extends 'main/base.html' %}

{% block title %}Новый склад{% endblock %}

{% block content %}
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
        white-space: normal; /* Позволяет переносу текста */
        overflow-wrap: break-word; /* Разбивает длинные слова */
    }
    th {
        background-color: #f2f2f2;
    }
    .center-text {
        text-align: center;
    }
    .availability-red {
        background-color: red;
    }
    .availability-yellow {
        background-color: yellow;
    }
    .availability-green {
        background-color: green;
    }
    .search-container {
        margin-bottom: 10px;
    }
    .availability {
        width: 30px; /* Уменьшаем ширину колонки */
        height: 20px; /* Высота индикатора */
        display: inline-block;
    }
    .sort-buttons {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .sort-buttons button {
        margin-left: 5px;
    }
</style>

<h1>Новый склад</h1>

<div class="search-container">
    <label for="searchInput">Поиск по таблице:</label>
    <input type="text" id="searchInput" placeholder="Поиск по таблице...">
</div>

<table id="warehouseTable">
    <thead>
        <tr>
            <th class="center-text">Наличие</th>
            <th class="center-text">Артикул</th>
            <th>Название</th>
            <th class="center-text">
                Количество
                <div class="sort-buttons">
                    <button id="sortAscBtn">⬆️</button>
                    <button id="sortDescBtn">⬇️</button>
                </div>
            </th>
            <th>Марка</th>
            <th>Модель</th>
            <th>Производитель</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td class="center-text">
                <div class="availability {% if item.quantity == 0 %}availability-red{% elif item.quantity == 1 %}availability-yellow{% else %}availability-green{% endif %}"></div>
            </td>
            <td class="center-text" style="width: 12ch;">{{ item.part_number }}</td>
            <td>{{ item.name }}</td>
            <td class="center-text">{{ item.quantity }}</td>
            <td>{{ item.brand }}</td>
            <td>{{ item.model }}</td>
            <td>{{ item.manufacturer }}</td>
            <td>
                <button class="editItemBtn" data-id="{{ item.id }}">Редактировать</button>
                <button class="deleteItemBtn" data-id="{{ item.id }}">Удалить</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button id="addItemBtn">Добавить новую деталь</button>

<div id="addItemModal" style="display: none;">
    <form id="addItemForm">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Добавить</button>
    </form>
</div>

<div id="editItemModal" style="display: none;">
    <form id="editItemForm">
        {% csrf_token %}
        <input type="hidden" name="id" id="editItemId">
        {{ form.as_p }}
        <button type="submit">Сохранить</button>
    </form>
</div>

<script>
document.getElementById('addItemBtn').addEventListener('click', function() {
    document.getElementById('addItemModal').style.display = 'block';
});

document.getElementById('addItemForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'add_item' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    }).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при добавлении детали: ' + JSON.stringify(data.errors));
        }
    }).catch(error => {
        console.error("Error during fetch: ", error);
        alert('Ошибка при добавлении детали: ' + error.message);
    });
});

document.querySelectorAll('.deleteItemBtn').forEach(button => {
    button.addEventListener('click', function() {
        if (confirm('Вы уверены, что хотите удалить эту деталь?')) {
            fetch("{% url 'delete_item' %}", {
                method: 'POST',
                body: JSON.stringify({ id: this.dataset.id }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            }).then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при удалении детали: ' + JSON.stringify(data.errors));
                }
            }).catch(error => {
                console.error("Error during fetch: ", error);
                alert('Ошибка при удалении детали: ' + error.message);
            });
        }
    });
});

document.querySelectorAll('.editItemBtn').forEach(button => {
    button.addEventListener('click', function() {
        document.getElementById('editItemId').value = this.dataset.id;
        // Fetch existing data and fill the form here (left for simplicity)
        document.getElementById('editItemModal').style.display = 'block';
    });
});

document.getElementById('editItemForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'edit_item' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    }).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при изменении детали: ' + JSON.stringify(data.errors));
        }
    }).catch(error => {
        console.error("Error during fetch: ", error);
        alert('Ошибка при изменении детали: ' + error.message);
    });
});

// Функция поиска
document.getElementById('searchInput').addEventListener('keyup', function() {
    var input, filter, table, tr, td, i, j, txtValue;
    input = document.getElementById('searchInput');
    filter = input.value.toLowerCase();
    table = document.getElementById('warehouseTable');
    tr = table.getElementsByTagName('tr');

    for (i = 1; i < tr.length; i++) {
        tr[i].style.display = 'none'; // Скрываем строку по умолчанию
        td = tr[i].getElementsByTagName('td');
        for (j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toLowerCase().indexOf(filter) > -1) {
                    tr[i].style.display = '';
                    break; // Если найдена совпадающая ячейка, показываем строку и прекращаем проверку других ячеек
                }
            }
        }
    }
});

// Функции сортировки
document.getElementById('sortAscBtn').addEventListener('click', function() {
    sortTable(true);
});

document.getElementById('sortDescBtn').addEventListener('click', function() {
    sortTable(false);
});

function sortTable(ascending) {
    var table, rows, switching, i, x, y, shouldSwitch;
    table = document.getElementById('warehouseTable');
    switching = true;
    while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
            shouldSwitch = false;
            x = rows[i].getElementsByTagName('td')[3]; // Колонка "Количество"
            y = rows[i + 1].getElementsByTagName('td')[3]; // Следующая строка, колонка "Количество"
            if (ascending) {
                if (parseInt(x.innerHTML) > parseInt(y.innerHTML)) {
                    shouldSwitch = true;
                    break;
                }
            } else {
                if (parseInt(x.innerHTML) < parseInt(y.innerHTML)) {
                    shouldSwitch = true;
                    break;
                }
            }
        }
        if (shouldSwitch) {
            rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
            switching = true;
        }
    }
}
</script>
{% endblock %}
