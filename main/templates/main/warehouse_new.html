<!-- main/templates/main/warehouse_new.html -->

{% extends 'main/base.html' %}

{% block title %}Новый склад{% endblock %}

{% block content %}
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
        width: 12ch; /* ширина столбца "Артикул" */
        white-space: nowrap; /* предотвращает перенос текста */
        overflow: hidden; /* скрывает переполненный текст */
        text-overflow: ellipsis; /* добавляет многоточие для переполненного текста */
    }
    th {
        background-color: #f2f2f2;
    }
    .marquee-container {
        position: relative;
        overflow: hidden;
    }
    .marquee {
        display: inline-block;
        white-space: nowrap;
        position: absolute;
        left: 0;
        animation: marquee 10s linear infinite;
        animation-play-state: paused; /* Останавливаем анимацию по умолчанию */
    }
    @keyframes marquee {
        from {
            transform: translateX(100%);
        }
        to {
            transform: translateX(-100%);
        }
    }
</style>

<h1>Новый склад</h1>
<table>
    <thead>
        <tr>
            <th>Артикул</th>
            <th>Название</th>
            <th>Количество</th>
            <th>Марка</th>
            <th>Модель</th>
            <th>Производитель</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        <tr>
            <td>{{ item.part_number }}</td>
            <td><div class="marquee-container"><div class="marquee">{{ item.name }}</div></div></td>
            <td>{{ item.quantity }}</td>
            <td><div class="marquee-container"><div class="marquee">{{ item.brand }}</div></div></td>
            <td><div class="marquee-container"><div class="marquee">{{ item.model }}</div></div></td>
            <td><div class="marquee-container"><div class="marquee">{{ item.manufacturer }}</div></div></td>
            <td>
                <button class="editItemBtn" data-id="{{ item.id }}">Редактировать</button>
                <button class="deleteItemBtn" data-id="{{ item.id }}">Удалить</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<button id="addItemBtn">Добавить новую деталь</button>

<div id="addItemModal" style="display: none;">
    <form id="addItemForm">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Добавить</button>
    </form>
</div>

<div id="editItemModal" style="display: none;">
    <form id="editItemForm">
        {% csrf_token %}
        <input type="hidden" name="id" id="editItemId">
        {{ form.as_p }}
        <button type="submit">Сохранить</button>
    </form>
</div>

<script>
document.getElementById('addItemBtn').addEventListener('click', function() {
    document.getElementById('addItemModal').style.display = 'block';
});

document.getElementById('addItemForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'add_item' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    }).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при добавлении детали: ' + JSON.stringify(data.errors));
        }
    }).catch(error => {
        console.error("Error during fetch: ", error);
        alert('Ошибка при добавлении детали: ' + error.message);
    });
});

document.querySelectorAll('.deleteItemBtn').forEach(button => {
    button.addEventListener('click', function() {
        if (confirm('Вы уверены, что хотите удалить эту деталь?')) {
            fetch("{% url 'delete_item' %}", {
                method: 'POST',
                body: JSON.stringify({ id: this.dataset.id }),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }).then(response => {
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                return response.json();
            }).then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка при удалении детали: ' + JSON.stringify(data.errors));
                }
            }).catch(error => {
                console.error("Error during fetch: ", error);
                alert('Ошибка при удалении детали: ' + error.message);
            });
        }
    });
});

document.querySelectorAll('.editItemBtn').forEach(button => {
    button.addEventListener('click', function() {
        document.getElementById('editItemId').value = this.dataset.id;
        // Fetch existing data and fill the form here (left for simplicity)
        document.getElementById('editItemModal').style.display = 'block';
    });
});

document.getElementById('editItemForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'edit_item' %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    }).then(response => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    }).then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Ошибка при изменении детали: ' + JSON.stringify(data.errors));
        }
    }).catch(error => {
        console.error("Error during fetch: ", error);
        alert('Ошибка при изменении детали: ' + error.message);
    });
});

// Проверка ширины текста и включение бегущей строки при необходимости
document.addEventListener('DOMContentLoaded', function() {
    const marqueeContainers = document.querySelectorAll('.marquee-container');
    marqueeContainers.forEach(container => {
        const marquee = container.querySelector('.marquee');
        if (marquee.scrollWidth > container.clientWidth) {
            marquee.style.animationPlayState = 'running';
        } else {
            marquee.style.animationPlayState = 'paused';
        }
    });
});
</script>
{% endblock %}
