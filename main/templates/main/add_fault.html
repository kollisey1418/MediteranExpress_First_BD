<!DOCTYPE html>
<html>
<head>
    <title>Добавить неисправность</title>
    <script>
        function addFaultForm() {
            const formIdx = document.querySelectorAll('.fault-form').length;
            const newForm = document.querySelector('.fault-form').cloneNode(true);
            newForm.querySelectorAll('input, select').forEach(input => {
                input.name = input.name.replace(/-\d+-/, `-${formIdx}-`);
                input.id = input.id.replace(/_\d+_/, `_${formIdx}_`);
                input.value = '';
            });
            document.querySelector('#fault-forms').appendChild(newForm);
        }

        function removeFaultForm(button) {
            const forms = document.querySelectorAll('.fault-form');
            if (forms.length > 1) {
                button.closest('.fault-form').remove();
            }
        }
    </script>
    <style>
        .popup {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid #ccc;
            padding: 20px;
            background: white;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="overlay" onclick="window.location.href='{% url 'car_detail' car.vin_code %}'"></div>
    <div class="popup">
        <h1>Добавить неисправность для автомобиля {{ car.brand }} {{ car.model }}</h1>
        <form method="post">
            {% csrf_token %}
            <div id="fault-forms">
                {{ formset.management_form }}
                {% for form in formset %}
                    <div class="fault-form">
                        {{ form.as_p }}
                        <button type="button" onclick="removeFaultForm(this)">Удалить</button>
                    </div>
                {% endfor %}
            </div>
            <button type="button" onclick="addFaultForm()">Добавить еще одну неисправность</button>
            <button type="submit">Сохранить</button>
        </form>
        {% if formset.errors %}
            <div class="errorlist">
                <ul>
                    {% for form in formset %}
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        <a href="{% url 'car_detail' car.vin_code %}">Назад к карточке автомобиля</a>
    </div>
</body>
</html>
